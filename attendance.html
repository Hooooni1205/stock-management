<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶œí‡´ê·¼ ê¸°ë¡</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        button {
            display: block;
            width: 80%;
            padding: 15px;
            margin: 10px auto;
            font-size: 18px;
            cursor: pointer;
        }
        #status {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h2>ğŸ•’ ì¶œí‡´ê·¼ ê¸°ë¡</h2>
    <p id="status">ë¡œê·¸ì¸ í™•ì¸ ì¤‘...</p>
    <button id="clockInButton" onclick="recordAttendance('ì¶œê·¼')">âœ… ì¶œê·¼</button>
    <button id="clockOutButton" onclick="askBreak()">ğŸšª í‡´ê·¼</button>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            let storedEmployeeId = localStorage.getItem("employeeId");
            let storedEmployeeName = localStorage.getItem("employeeName");
    
            // âœ… URLì—ì„œ employeeId, employeeName ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const urlEmployeeId = urlParams.get("employeeId");
            const urlEmployeeName = urlParams.get("employeeName");
    
            // âœ… URLì— ê°’ì´ ìˆìœ¼ë©´ localStorageì— ì €ì¥
            if (urlEmployeeId && urlEmployeeName) {
                localStorage.setItem("employeeId", urlEmployeeId);
                localStorage.setItem("employeeName", urlEmployeeName);
                storedEmployeeId = urlEmployeeId;
                storedEmployeeName = urlEmployeeName;
            }
    
            console.log("ğŸ” [attendance.html] ìµœì¢… ë¡œê·¸ì¸ ì •ë³´:");
            console.log("â¡ï¸ employeeId:", storedEmployeeId);
            console.log("â¡ï¸ employeeName:", storedEmployeeName);
    
            if (storedEmployeeId && storedEmployeeName) {
                console.log("âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:", storedEmployeeName);
                showAttendanceUI(storedEmployeeName);
            } else {
                console.log("ğŸš¨ ë¡œê·¸ì¸ ì •ë³´ ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”");
                document.getElementById("loginNotice").style.display = "block";
            }
        });
        
        function showAttendanceUI(employeeName) {
            document.getElementById("loginNotice").style.display = "none"; // ë¡œê·¸ì¸ ë©”ì‹œì§€ ìˆ¨ê¹€
            document.getElementById("attendanceUI").style.display = "block"; // ì¶œí‡´ê·¼ UI í‘œì‹œ
            document.getElementById("employeeName").innerText = employeeName; // ì§ì› ì´ë¦„ í‘œì‹œ
        }

        document.addEventListener("DOMContentLoaded", function () {
            const storedEmployeeId = localStorage.getItem("employeeId");
            
            if (storedEmployeeId) {
                console.log("âœ… ë¡œê·¸ì¸ í™•ì¸ë¨. ìë™ìœ¼ë¡œ QR ìŠ¤ìºë„ˆ ì‹¤í–‰");
                startQRScanner();
            }
        });
        
        function startQRScanner() {
            const scanner = new Instascan.Scanner({ video: document.getElementById('preview') });
            
            scanner.addListener('scan', function (content) {
                console.log("âœ… QR ì½”ë“œ ê°ì§€ë¨: ", content);
                handleAttendance(content); // ì¶œê·¼/í‡´ê·¼ ë¡œì§ ì‹¤í–‰
            });
        
            Instascan.Camera.getCameras().then(function (cameras) {
                if (cameras.length > 0) {
                    scanner.start(cameras[0]);
                } else {
                    console.error("ğŸš¨ ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }).catch(function (error) {
                console.error("ğŸš¨ ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:", error);
            });
        }

        
        const employeeId = localStorage.getItem("employeeId");

        if (!employeeId) {
            document.getElementById("status").innerText = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.";
            document.getElementById("clockInButton").style.display = "none";
            document.getElementById("clockOutButton").style.display = "none";
        } else {
            document.getElementById("status").innerText = "ì¶œí‡´ê·¼ ê¸°ë¡ì„ ì„ íƒí•˜ì„¸ìš”.";
        }

        function recordAttendance(type, restUse = "-") {
            google.script.run.recordAttendance(employeeId, type, restUse);
            alert(`${type}ì´ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            window.location.href = "index.html"; // âœ… ê¸°ë¡ í›„ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        }

        function askBreak() {
            let restUse = confirm("íœ´ê²Œì‹œê°„ì„ ì‚¬ìš©í•˜ì…¨ë‚˜ìš”? (í™•ì¸: O, ì·¨ì†Œ: X)");
            restUse = restUse ? "íœ´ê²Œì‚¬ìš©O" : "íœ´ê²Œì‚¬ìš©X";
            recordAttendance("í‡´ê·¼", restUse);
        }
    </script>
</body>
</html>
